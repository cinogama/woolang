import rscene.std;
import rscene.vm;

import test_tool;

namespace test_vm
{
    func load_and_create_vmm(var src:string)
    {
        var vmm = std::vm::create();
        vmm->load_source(src);
        return vmm;
    }

    func main()
    {
       var vmm = load_and_create_vmm(
            @"
            import rscene.std;
            func main()
            {
                std::println("Hey! This inform come from another vm!~");
            }
            main();
            "@
        );

        test_equal(vmm->has_error(), false);

        vmm->run();
        vmm->close();

        // Test memmory leak
        var i = 0;
        while (i<1000)
        {
            i += 1;
            var vmm = load_and_create_vmm(
                @"
                import rscene.std;
                func main()
                {
                    var a = [1,2,3,4,5];
                    var b = a + a;
                    
                    // TODO: b is array<pending>, FIX IT
                }
                main();
                "@
            );
            test_equal(vmm->has_error(), false);
            if (vmm->has_error())
            {
                std::println(vmm->error_msg());
            }
            vmm->run();
            vmm->close();
        }
    }
}

test_function("test_vm.main", test_vm::main);