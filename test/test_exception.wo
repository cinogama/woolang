import woo.std;
import woo.vm;
import woo.debug;

import test_tool;

namespace test_exception
{
	func foo()
	{
		std::throw("an exception~");
	}
	func main()
	{
		except
		{
			foo();
			std::halt("This cannot be shown.");
		}
		var vmm = std::vm::create();
        vmm->load_source("test_vm/test_exception.rsn", @"
import woo.std;
func test()
{
	static var n = 0;
	if (n == 1)
		std::throw("This exception should be throw.");
	else
		std::println("ok!");
	n += 1;

	return n;
}
test();
"@);
        test_assure(vmm->run() == 1);
		test_assure(std::debug::invoke(std::vm::run, vmm) == nil);
		
		// This two function will not run.
		test_assure(std::debug::invoke(std::vm::run, vmm) == nil);
		test_assure(vmm->run() == nil);
	}
}

test_function("test_exception.main", test_exception::main);